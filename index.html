<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hiking & Motorcycling — Petru & Ioana</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#e74c3c',
        'primary-hover': '#c0392b',
        bg: '#0a0a0a',
        card: '#151515',
        muted: '#888',
        frame: '#1f1f1f',
        border: '#333',
        'border-light': '#2a2a2a',
        text: '#ffffff',
        'text-secondary': '#e0e0e0',
      },
      boxShadow: {
        sm: '0 2px 4px rgba(0,0,0,0.3)',
        md: '0 4px 12px rgba(0,0,0,0.4)',
        lg: '0 8px 24px rgba(0,0,0,0.5)',
      },
      fontFamily: {
        inter: ['Inter','-apple-system','BlinkMacSystemFont','Segoe UI','Arial','sans-serif'],
      }
    }
  }
}
</script>

<style>
html, body { background: #0a0a0a; }
.custom-scrollbar::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
.hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
.hide-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="bg-bg text-text font-inter antialiased min-h-screen max-w-full overflow-x-hidden">

<!-- DESKTOP HEADER -->
<header class="hidden md:flex fixed inset-x-0 top-0 h-[200px] bg-gradient-to-b from-black via-bg to-[#0f0f0f] flex items-center justify-center border-b border-border shadow-md z-[800] px-7 py-[18px] box-border">
  <div class="flex flex-col md:flex-row items-center gap-6 md:gap-10">
    <div class="hero-photo left w-[104px] h-[104px] rounded-full overflow-hidden border-4 border-frame shadow-md shadow-black/30 hover:shadow-lg hover:shadow-black/50 transition-all duration-200 flex-shrink-0 bg-[#0d0d0d]">
      <img src="images/petru_ioana.jpeg" alt="Petru and Ioana" loading="lazy" class="w-full h-full object-cover" />
    </div>
    <div class="title text-center leading-tight flex flex-col gap-2">
      <h1 class="text-[28px] font-bold tracking-[0.2px] text-text m-0">GPX Routes — by Petru & Ioana</h1>
      <h2 class="text-[28px] font-bold tracking-[0.2px] text-text m-0">Hiking Trails & Motorcycle Rides</h2>
      <div class="subtitle text-base text-muted font-medium">Pick a route, explore the map, and download GPX for free.</div>
    </div>
    <div class="hero-photo right w-[104px] h-[104px] rounded-full overflow-hidden border-4 border-frame shadow-md shadow-black/30 hover:shadow-lg hover:shadow-black/50 transition-all duration-200 flex-shrink-0 bg-[#0d0d0d]">
      <img src="images/motorcycle.jpeg" alt="Motorcycle" loading="lazy" class="w-full h-full object-cover" />
    </div>
  </div>
</header>

<div class="flex flex-col md:grid md:grid-cols-[320px_1fr_320px] lg:grid-cols-[360px_1fr_360px] gap-[18px] px-[18px] pb-[18px] pt-[200px] md:pt-[200px] min-h-[calc(100vh-200px)]">

  <!-- LEFT PANEL Hiking -->
  <aside id="hiking-panel" class="hidden md:flex flex-col gap-3 bg-gradient-to-b from-card to-[#121212] border border-border-light rounded-xl p-4 shadow-sm overflow-hidden">
    <h3 class="text-lg font-semibold flex justify-between items-center text-text tracking-[-0.01em] mb-0">Hiking Routes <span class="text-muted" id="hiking-count"></span></h3>
    <div class="flex justify-center w-full mt-2">
      <div class="toggle inline-flex border border-border rounded-2xl overflow-hidden bg-frame shadow-sm" data-kind="hiking">
        <button class="toggle-btn px-4 py-2 text-sm font-semibold cursor-pointer bg-primary text-white transition-colors duration-200" data-view="completed">Completed</button>
        <button class="toggle-btn px-4 py-2 text-sm font-medium cursor-pointer text-muted hover:text-text-secondary transition-colors duration-200" data-view="upcoming">Upcoming</button>
      </div>
    </div>
    <div class="flex gap-2 mt-2">
      <input id="search-hiking" placeholder="Search hiking routes..." class="flex-1 px-3 py-2 text-sm border border-border rounded-lg bg-frame text-text outline-none focus:border-primary focus:bg-card focus:ring-1 focus:ring-primary/10" />
      <button class="btn px-3 py-2 text-sm font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200" id="clear-hiking">Clear</button>
    </div>
    <div class="overflow-auto pr-1 flex flex-col flex-1 min-h-0" id="hiking-list" aria-live="polite"></div>
    <div class="upcoming-list overflow-auto pr-1 hidden flex-col gap-2 flex-1 min-h-0" id="hiking-upcoming-list" aria-live="polite"></div>
  </aside>

  <!-- RIGHT PANEL Motorcycle -->
  <aside id="motor-panel" class="hidden md:flex flex-col gap-3 bg-gradient-to-b from-card to-[#121212] border border-border-light rounded-xl p-4 shadow-sm overflow-hidden">
    <h3 class="text-lg font-semibold flex justify-between items-center text-text tracking-[-0.01em] mb-0">Motorcycle Routes <span class="text-muted" id="motor-count"></span></h3>
    <div class="flex justify-center w-full mt-2">
      <div class="toggle inline-flex border border-border rounded-2xl overflow-hidden bg-frame shadow-sm" data-kind="motorcycle">
        <button class="toggle-btn px-4 py-2 text-sm font-semibold cursor-pointer bg-primary text-white transition-colors duration-200" data-view="completed">Completed</button>
        <button class="toggle-btn px-4 py-2 text-sm font-medium cursor-pointer text-muted hover:text-text-secondary transition-colors duration-200" data-view="upcoming">Upcoming</button>
      </div>
    </div>
    <div class="flex gap-2 mt-2">
      <input id="search-motor" placeholder="Search motorcycle routes..." class="flex-1 px-3 py-2 text-sm border border-border rounded-lg bg-frame text-text outline-none focus:border-primary focus:bg-card focus:ring-1 focus:ring-primary/10" />
      <button class="btn px-3 py-2 text-sm font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200" id="clear-motor">Clear</button>
    </div>
    <div class="overflow-auto pr-1 flex flex-col flex-1 min-h-0" id="motor-list" aria-live="polite"></div>
    <div class="upcoming-list overflow-auto pr-1 hidden flex-col gap-2 flex-1 min-h-0" id="motor-upcoming-list" aria-live="polite"></div>
  </aside>

  <!-- MAP -->
  <main class="bg-gradient-to-b from-card to-[#0f0f0f] border border-border-light rounded-xl p-[14px] box-border flex flex-col gap-3 h-[60vh] md:h-full max-h-full shadow-sm hover:border-border hover:shadow-md transition-all duration-200 md:col-start-2 md:row-start-1">
    <div class="flex justify-between items-center">
      <div class="font-semibold text-sm">Map</div>
      <div class="map-controls flex gap-2 items-center justify-end">
        <button id="btn-tiles" class="px-4 py-2 text-sm font-medium rounded-lg bg-card border border-border cursor-pointer text-text-secondary hover:bg-frame hover:text-text transition-all duration-200 shadow-sm hover:shadow-md">Satellite</button>
        <button id="btn-clear" class="px-4 py-2 text-sm font-medium rounded-lg bg-card border border-border cursor-pointer text-text-secondary hover:bg-frame hover:text-text transition-all duration-200 shadow-sm hover:shadow-md">Clear routes</button>
      </div>
    </div>
    <div id="map" class="flex-1 rounded-xl overflow-hidden border-2 border-border shadow-sm"></div>
  </main>
</div>

<!-- MOBILE HEADER + MAP + Toggle -->
<div class="md:hidden flex flex-col min-h-screen">
  <header class="flex items-center justify-center h-[64px] border-b border-border px-2 bg-gradient-to-b from-black via-bg to-[#0f0f0f] gap-2">
    <img src="images/petru_ioana.jpeg" alt="Petru" class="w-[32px] h-[32px] rounded-full border-2 border-frame object-cover" />
    <div class="flex flex-col flex-1 min-w-0 text-center">
      <h1 class="text-[10px] font-bold text-text truncate">GPX Routes — by Petru & Ioana</h1>
      <h2 class="text-[9px] font-bold text-text truncate">Hiking Trails & Motorcycle Rides</h2>
      <div class="subtitle text-[9px] text-muted truncate">Pick a route, explore the map, and download GPX.</div>
    </div>
    <img src="images/motorcycle.jpeg" alt="Moto" class="w-[32px] h-[32px] rounded-full border-2 border-frame object-cover" />
  </header>
  <main class="w-full aspect-[4/3] min-h-[75vw] max-h-[75vw] bg-gradient-to-b from-card to-[#0f0f0f] border-b border-border relative">
    <div id="map-mobile" class="w-full h-full"></div>
    <div class="flex gap-2 absolute bottom-2 left-2 right-2">
      <button id="btn-hiking" class="flex-1 py-2 rounded-full bg-primary text-white font-semibold">Hiking</button>
      <button id="btn-moto" class="flex-1 py-2 rounded-full bg-gray-700 text-white font-semibold">Moto</button>
    </div>
  </main>
  <div class="px-2 pb-2 flex flex-col gap-2">
    <aside id="hiking-panel-mobile" class="hidden flex-col gap-2">
      <!-- same content dynamically rendered by JS -->
    </aside>
    <aside id="motor-panel-mobile" class="hidden flex-col gap-2">
      <!-- same content dynamically rendered by JS -->
    </aside>
  </div>
</div>

<!-- Leaflet + GPX -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<!-- JS unificat GPX / toggles / search / clear -->
<script>
// === JS code identical cu codul desktop pentru GPX, parking, show/download, toggle buttons, search/clear
// doar ca verificam daca suntem pe mobile sau desktop pentru map target și panouri

const isMobile = window.innerWidth < 768;
const mapEl = isMobile ? document.getElementById('map-mobile') : document.getElementById('map');
const map = L.map(mapEl, {center:[50.5,4.5], zoom:7, preferCanvas:true});
const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap'});
const baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'Esri Satellite'});
let satOn = true; baseSat.addTo(map);
let currentGPX = null, parkingMarkers=[], activeShowButton=null, activeParkingButton=null;
const state = { completed:null, upcoming:{hiking:[],motorcycle:[]}, view:{hiking:'completed',motorcycle:'completed'} };

// Fetch JSON + render lists
Promise.all([
  fetch('./data/trasee.json').then(r=>r.json()),
  fetch('./data/hiking_upcoming.json').then(r=>r.ok?r.json():[]),
  fetch('./data/moto_upcoming.json').then(r=>r.ok?r.json():[]),
]).then(([completed,hikingUpcoming,motoUpcoming])=>{
  state.completed=completed||{};
  state.upcoming.hiking=hikingUpcoming||[];
  state.upcoming.motorcycle=motoUpcoming||[];
  setupToggles(); setupFilters();
  renderColumn('hiking'); renderColumn('motorcycle');
}).catch(err=>console.error(err));

function setupToggles(){
  document.querySelectorAll('.toggle').forEach(toggle=>{
    const kind = toggle.dataset.kind;
    toggle.querySelectorAll('.toggle-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        toggle.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('bg-primary','text-white','font-semibold'));
        btn.classList.add('bg-primary','text-white','font-semibold');
        state.view[kind] = btn.dataset.view;
        renderColumn(kind);
      });
    });
  });

  // mobile Hiking/Moto toggle
  if(isMobile){
    const btnH = document.getElementById('btn-hiking');
    const btnM = document.getElementById('btn-moto');
    const hikingPanelMobile = document.getElementById('hiking-panel-mobile');
    const motorPanelMobile = document.getElementById('motor-panel-mobile');
    btnH.addEventListener('click', ()=>{hikingPanelMobile.classList.remove('hidden'); motorPanelMobile.classList.add('hidden'); btnH.classList.add('bg-primary'); btnH.classList.remove('bg-gray-700'); btnM.classList.remove('bg-primary'); btnM.classList.add('bg-gray-700');});
    btnM.addEventListener('click', ()=>{motorPanelMobile.classList.remove('hidden'); hikingPanelMobile.classList.add('hidden'); btnM.classList.add('bg-primary'); btnM.classList.remove('bg-gray-700'); btnH.classList.remove('bg-primary'); btnH.classList.add('bg-gray-700');});
    hikingPanelMobile.classList.remove('hidden'); btnH.classList.add('bg-primary');
  }
}

// alte functii: setupFilters, renderColumn, updateCount, renderCompleted, renderUpcoming, createRouteCard, loadAndShowGPX, addParkingPoint, escapeHtml
// aceleași ca în codul desktop, doar verificăm target container pentru mobile/desktop

<script>
// --- Config ---
const DATA_URL = './data/trasee.json'; // completed routes
const HIKING_UPCOMING_URL = './data/hiking_upcoming.json';
const MOTO_UPCOMING_URL = './data/moto_upcoming.json';
const ESRI_SAT = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
const OSM = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

// --- Map init ---
const map = L.map('map', {
  center: [50.5, 4.5],
  zoom: 7,
  preferCanvas: true
});
const baseOSM = L.tileLayer(OSM, { attribution: '© OpenStreetMap contributors' });
const baseSat = L.tileLayer(ESRI_SAT, { attribution: 'Esri Satellite' });
baseSat.addTo(map);

let currentGPX = null;
let parkingMarkers = [];
let activeShowButton = null;
let activeParkingButton = null;
const state = {
  completed: null,
  upcoming: { hiking: [], motorcycle: [] },
  view: { hiking: 'completed', motorcycle: 'completed' }
};

// --- Tile toggle ---
let satOn = true;
const btnTiles = document.getElementById('btn-tiles');
btnTiles.textContent = 'Map';
btnTiles.addEventListener('click', () => {
  if(!satOn){
    baseSat.addTo(map);
    baseOSM.remove();
    btnTiles.textContent = 'Map';
    satOn = true;
  } else {
    baseOSM.addTo(map);
    baseSat.remove();
    btnTiles.textContent = 'Satellite';
    satOn = false;
  }
});

// --- Clear GPX / Parking ---
document.getElementById('btn-clear').addEventListener('click', ()=>{
  clearGPX();
  clearParkings();
  if(activeShowButton) resetButton(activeShowButton); activeShowButton=null;
  if(activeParkingButton) resetButton(activeParkingButton); activeParkingButton=null;
});

function clearGPX(){ if(currentGPX){ try{map.removeLayer(currentGPX);}catch{} currentGPX=null; } }
function clearParkings(){ parkingMarkers.forEach(m=>map.removeLayer(m)); parkingMarkers=[]; }
function resetButton(btn){
  btn.classList.remove('bg-primary','border-primary','text-white','font-semibold');
  btn.classList.add('bg-card','border-border','text-text-secondary');
}

// --- Show / Parking button helpers ---
function setActiveShowButton(newButton){
  if(activeShowButton===newButton){ resetButton(newButton); activeShowButton=null; clearGPX(); clearParkings(); return false; }
  if(activeShowButton) resetButton(activeShowButton);
  activeShowButton = newButton;
  newButton.classList.remove('bg-card','border-border','text-text-secondary');
  newButton.classList.add('bg-primary','border-primary','text-white','font-semibold');
  return true;
}
function setActiveParkingButton(newButton, coordsStr, title){
  if(activeParkingButton===newButton){ resetButton(newButton); activeParkingButton=null; clearParkings(); return false; }
  if(activeParkingButton) resetButton(activeParkingButton);
  clearParkings();
  if(coordsStr && title) addParkingPoint(coordsStr,title);
  activeParkingButton=newButton;
  newButton.classList.remove('bg-card','border-border','text-text-secondary');
  newButton.classList.add('bg-primary','border-primary','text-white','font-semibold');
  return true;
}

// --- Load JSON ---
Promise.all([
  fetch(DATA_URL).then(r=>r.ok?r.json():[]),
  fetch(HIKING_UPCOMING_URL).then(r=>r.ok?r.json():[]),
  fetch(MOTO_UPCOMING_URL).then(r=>r.ok?r.json():[])
])
.then(([completed,hikingUpcoming,motoUpcoming])=>{
  state.completed=completed||{};
  state.upcoming.hiking=hikingUpcoming||[];
  state.upcoming.motorcycle=motoUpcoming||[];
  setupToggles();
  setupFilters();
  renderColumn('hiking');
  renderColumn('motorcycle');
})
.catch(err=>{ console.error(err); document.getElementById('hiking-list').innerText='Failed to load data'; document.getElementById('motor-list').innerText='Failed to load data'; });

// --- Toggle Completed / Upcoming ---
function setupToggles(){
  document.querySelectorAll('.toggle').forEach(toggle=>{
    const kind=toggle.dataset.kind;
    toggle.querySelectorAll('.toggle-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        toggle.querySelectorAll('.toggle-btn').forEach(b=>{
          b.classList.remove('bg-primary','text-white','font-semibold');
          b.classList.add('text-muted','hover:text-text-secondary');
        });
        btn.classList.remove('text-muted','hover:text-text-secondary');
        btn.classList.add('bg-primary','text-white','font-semibold');
        state.view[kind] = btn.dataset.view;
        renderColumn(kind);
      });
    });
  });
}

// --- Search / Filter ---
function setupFilters(){
  document.getElementById('search-hiking').addEventListener('input', e=>filterList('hiking', e.target.value));
  document.getElementById('search-motor').addEventListener('input', e=>filterList('motorcycle', e.target.value));
  document.getElementById('clear-hiking').addEventListener('click', ()=>{ document.getElementById('search-hiking').value=''; filterList('hiking',''); });
  document.getElementById('clear-motor').addEventListener('click', ()=>{ document.getElementById('search-motor').value=''; filterList('motorcycle',''); });
}
function filterList(kind,q){
  q=(q||'').toLowerCase().trim();
  const view=state.view[kind]||'completed';
  const container=view==='completed'
    ? (kind==='hiking'?document.getElementById('hiking-list'):document.getElementById('motor-list'))
    : (kind==='hiking'?document.getElementById('hiking-upcoming-list'):document.getElementById('motor-upcoming-list'));
  Array.from(container.children).forEach(card=>{
    const txt=(card.dataset.search||'').toLowerCase();
    card.style.display=txt.includes(q)?'none':'';
  });
}

// --- Render ---
function renderColumn(kind){
  const view=state.view[kind]||'completed';
  const completedList=kind==='hiking'?document.getElementById('hiking-list'):document.getElementById('motor-list');
  const upcomingList=kind==='hiking'?document.getElementById('hiking-upcoming-list'):document.getElementById('motor-upcoming-list');
  if(view==='completed'){ completedList.style.display='block'; upcomingList.style.display='none'; renderCompleted(kind,completedList); updateCount(kind,(state.completed?.[kind]||[]).length,'routes'); }
  else{ completedList.style.display='none'; upcomingList.style.display='flex'; renderUpcoming(kind,upcomingList); updateCount(kind,(state.upcoming[kind]||[]).length,'upcoming'); }
  filterList(kind,(document.getElementById(kind==='hiking'?'search-hiking':'search-motor').value||''));
}
function updateCount(kind,count,label){ const el=kind==='hiking'?document.getElementById('hiking-count'):document.getElementById('motor-count'); if(el) el.textContent=`${count} ${label}`; }

function renderCompleted(kind,container){
  container.innerHTML='';
  (state.completed?.[kind]||[]).forEach((t,i)=>{ const card=createRouteCard(t,kind,i); container.appendChild(card); });
}
function renderUpcoming(kind,container){
  container.innerHTML='';
  const items=state.upcoming[kind]||[];
  if(!items.length){ const empty=document.createElement('div'); empty.className='text-muted'; empty.textContent='No upcoming routes'; container.appendChild(empty); return; }
  items.forEach(u=>{
    const item=document.createElement('div');
    item.className='border border-border-light rounded-xl p-2 mb-2 bg-gradient-to-b from-white/2 to-white/0.5 shadow-sm hover:border-border hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 flex flex-col gap-1';
    item.dataset.search = u.name||'';
    const name = document.createElement('div'); name.className='font-semibold text-text flex-1 overflow-hidden text-ellipsis whitespace-nowrap'; name.textContent=u.name||'Route'; item.appendChild(name);
    if(u.description||u.notes){ const desc=document.createElement('div'); desc.className='text-muted text-xs mt-1 mb-1 px-1'; desc.textContent=u.description||u.notes; item.appendChild(desc); }
    const actions=document.createElement('div'); actions.className='flex gap-1 justify-center w-full pt-1 border-t border-border-light mt-auto';
    const showBtn=document.createElement('button'); showBtn.className='px-2 py-1 text-xs font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-sm'; showBtn.textContent='Show'; showBtn.disabled=!u.gpx; showBtn.title=u.gpx?'Show this GPX on the map':'No GPX available';
    showBtn.addEventListener('click',()=>{ if(!u.gpx){alert('No GPX available'); return;} if(setActiveShowButton(showBtn)){ loadAndShowGPX(u.gpx); } });
    actions.appendChild(showBtn);
    const dlBtn=document.createElement('a'); dlBtn.className='px-2 py-1 text-xs font-semibold rounded-lg bg-primary border border-primary text-white cursor-pointer shadow-sm hover:bg-primary-hover hover:border-primary-hover hover:-translate-y-0.5 hover:shadow-md transition-all duration-200'; dlBtn.textContent='Download GPX'; dlBtn.setAttribute('download',''); if(u.gpx){ dlBtn.href=u.gpx; dlBtn.title='Download this GPX file'; } else { dlBtn.href='javascript:void(0)'; dlBtn.setAttribute('aria-disabled','true'); dlBtn.className+=' opacity-40 cursor-not-allowed pointer-events-none'; dlBtn.title='No GPX available'; } actions.appendChild(dlBtn);
    if(kind!=='motorcycle' && u.trailhead && u.trailhead.coords){
      const btnPark=document.createElement('button'); btnPark.className='px-2 py-1 text-xs font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200'; btnPark.textContent='Parking'; btnPark.title='Show parking point on map';
      btnPark.addEventListener('click',()=>{ setActiveParkingButton(btnPark,u.trailhead.coords,u.trailhead.name||u.name); });
      actions.appendChild(btnPark);
    }
    item.appendChild(actions);
    container.appendChild(item);
  });
}

// --- Create card for completed ---
function createRouteCard(traseu,kind,index){
  const name=traseu.name||(traseu.photo?traseu.photo.split('/').pop().split('.')[0]:'Route');
  const km=traseu.km?`${traseu.km} km`:'';
  const difficulty=traseu.difficulty||'';
  const gpx=traseu.gpx||null;
  const card=document.createElement('div');
  card.className='border border-border-light rounded-xl p-2 mb-2 bg-gradient-to-b from-white/2 to-white/0.5 shadow-sm hover:border-border hover:shadow-md hover:-translate-y-0.5 transition-all duration-200';
  card.dataset.search=`${name} ${km} ${difficulty}`;
  const meta=document.createElement('div'); meta.className='mb-1'; meta.innerHTML=`<div class="flex flex-col gap-1"><strong class="text-text">${escapeHtml(name)}</strong><div class="text-muted text-xs">${escapeHtml(km)}${difficulty?' • '+escapeHtml(difficulty):''}</div></div>`; card.appendChild(meta);
  const details=document.createElement('div'); details.className='text-muted text-xs mb-1 px-1'; details.innerHTML=(traseu.trailhead&&traseu.trailhead.name?`Start: ${escapeHtml(traseu.trailhead.name)}<br/>`:'')+(traseu.trailhead&&traseu.trailhead.coords?`Coords: ${escapeHtml(traseu.trailhead.coords)}`:''); if(details.innerHTML) card.appendChild(details);
  const actions=document.createElement('div'); actions.className='flex gap-1 justify-center w-full pt-1 border-t border-border-light mt-1';
  const btnShow=document.createElement('button'); btnShow.className='px-2 py-1 text-xs font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-sm'; btnShow.textContent='Show GPX'; btnShow.disabled=!gpx; btnShow.title=gpx?'Show this GPX on the map':'No GPX available'; btnShow.addEventListener('click',()=>{ if(!gpx){alert('No GPX available'); return;} if(setActiveShowButton(btnShow)){ loadAndShowGPX(gpx); } }); actions.appendChild(btnShow);
  if(kind!=='motorcycle' && traseu.trailhead && traseu.trailhead.coords){
    const btnPark=document.createElement('button'); btnPark.className='px-2 py-1 text-xs font-medium rounded-lg border border-border bg-card text-text-secondary cursor-pointer shadow-sm hover:bg-frame hover:text-text hover:-translate-y-0.5 hover:shadow-md transition-all duration-200'; btnPark.textContent='Parking'; btnPark.title='Show parking point on map';
    btnPark.addEventListener('click',()=>{ setActiveParkingButton(btnPark,traseu.trailhead.coords,traseu.trailhead.name||traseu.name); });
    actions.appendChild(btnPark);
  }
  const dlBtn=document.createElement('a'); dlBtn.className='px-2 py-1 text-xs font-semibold rounded-lg bg-primary border border-primary text-white cursor-pointer shadow-sm hover:bg-primary-hover hover:border-primary-hover hover:-translate-y-0.5 hover:shadow-md transition-all duration-200'; dlBtn.textContent='Download GPX'; dlBtn.setAttribute('download',''); if(gpx){ dlBtn.href=gpx; dlBtn.title='Download this GPX file'; } else { dlBtn.href='javascript:void(0)'; dlBtn.setAttribute('aria-disabled','true'); dlBtn.className+=' opacity-40 cursor-not-allowed pointer-events-none'; dlBtn.title='No GPX available'; } actions.appendChild(dlBtn);
  card.appendChild(actions);
  return card;
}

// --- Load GPX ---
function loadAndShowGPX(url){
  clearGPX(); clearParkings();
  const gpxLayer = new L.GPX(url, { async:true, polyline_options:{color:'#e74c3c',weight:4,opacity:0.9}, marker_options:{startIconUrl:null,endIconUrl:null,shadowUrl:null} })
    .on('loaded',e=>{ currentGPX=gpxLayer; map.fitBounds(gpxLayer.getBounds(),{padding:[40,40]}); })
    .on('error',e=>{ alert('Failed to load GPX: '+url); console.error(e); })
    .addTo(map);
  currentGPX=gpxLayer;
}

// --- Add Parking ---
function addParkingPoint(coordsStr,title){
  if(!coordsStr) return;
  const parts=coordsStr.split(',').map(s=>parseFloat(s.trim()));
  if(parts.length<2||isNaN(parts[0])||isNaN(parts[1])){ alert('Invalid coords: '+coordsStr); return; }
  const m=L.marker([parts[0],parts[1]]).addTo(map).bindPopup(`<strong>${escapeHtml(title||'Parking')}</strong><br>${escapeHtml(coordsStr)}`);
  parkingMarkers.push(m); map.panTo([parts[0],parts[1]]); m.openPopup();
}

// --- Escape HTML ---
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[ch]); }

// --- Mobile toggle Hiking / Moto ---
const btnHiking=document.getElementById('btn-hiking');
const btnMoto=document.getElementById('btn-moto');
const hikingPanel=document.getElementById('hiking-panel');
const motorPanel=document.getElementById('motor-panel');
hikingPanel.classList.remove('hidden');
btnHiking.classList.add('bg-primary'); btnMoto.classList.add('bg-gray-700');
btnHiking.addEventListener('click',()=>{
  hikingPanel.classList.remove('hidden'); motorPanel.classList.add('hidden'); btnHiking.classList.add('bg-primary'); btnHiking.classList.remove('bg-gray-700'); btnMoto.classList.remove('bg-primary'); btnMoto.classList.add('bg-gray-700');
});
btnMoto.addEventListener('click',()=>{
  motorPanel.classList.remove('hidden'); hikingPanel.classList.add('hidden'); btnMoto.classList.add('bg-primary'); btnMoto.classList.remove('bg-gray-700'); btnHiking.classList.remove('bg-primary'); btnHiking.classList.add('bg-gray-700');
});
</script>
</body>
</html>
